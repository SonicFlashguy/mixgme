/**
 * Technical Analysis Dashboard Component
 * Displays RSI, MACD, Moving Averages, Bollinger Bands, and Overall Trading Signal
 */

import React, { useState, useEffect, useMemo } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  performTechnicalAnalysis, 
  getTradingRecommendation,
  type TechnicalAnalysisResult,
  type RSIData,
  type MACDData,
  type MovingAverageData,
  type BollingerBandsData,
  type VolumeAnalysisData
} from '../../lib/technical-analysis';
import type { CandleData } from '../../types/chart';

interface TechnicalAnalysisPanelProps {
  candleData: CandleData[];
  isVisible: boolean;
  onToggle: () => void;
}

const SignalBadge: React.FC<{ 
  signal: 'bullish' | 'bearish' | 'neutral' | 'strong_bullish' | 'strong_bearish';
  strength?: number;
  size?: 'sm' | 'md' | 'lg';
}> = ({ signal, strength = 0.5, size = 'md' }) => {
  const getSignalColor = (signal: string) => {
    switch (signal) {
      case 'strong_bullish': return 'bg-emerald-500 text-white';
      case 'bullish': return 'bg-green-500 text-white';
      case 'strong_bearish': return 'bg-red-600 text-white';
      case 'bearish': return 'bg-red-500 text-white';
      default: return 'bg-gray-500 text-white';
    }
  };

  const getSignalText = (signal: string) => {
    switch (signal) {
      case 'strong_bullish': return 'STRONG BUY';
      case 'bullish': return 'BUY';
      case 'strong_bearish': return 'STRONG SELL';
      case 'bearish': return 'SELL';
      default: return 'HOLD';
    }
  };

  const sizeClasses = {
    sm: 'px-2 py-1 text-xs',
    md: 'px-3 py-1.5 text-sm',
    lg: 'px-4 py-2 text-base'
  };

  return (
    <motion.div
      initial={{ scale: 0.8, opacity: 0 }}
      animate={{ scale: 1, opacity: 1 }}
      className={`
        inline-flex items-center rounded-full font-semibold
        ${getSignalColor(signal)} ${sizeClasses[size]}
      `}
    >
      <div className={`w-2 h-2 rounded-full bg-white/30 mr-2 animate-pulse`} />
      {getSignalText(signal)}
      {strength && (
        <span className="ml-2 text-xs opacity-75">
          {(strength * 100).toFixed(0)}%
        </span>
      )}
    </motion.div>
  );
};

const IndicatorCard: React.FC<{
  title: string;
  value: number;
  signal: 'bullish' | 'bearish' | 'neutral';
  strength?: number;
  subtitle?: string;
  trend?: 'up' | 'down' | 'sideways';
  children?: React.ReactNode;
}> = ({ title, value, signal, strength, subtitle, trend, children }) => {
  const getTrendIcon = (trend?: string) => {
    switch (trend) {
      case 'up': return '‚ÜóÔ∏è';
      case 'down': return '‚ÜòÔ∏è';
      default: return '‚û°Ô∏è';
    }
  };

  return (
    <motion.div
      initial={{ y: 20, opacity: 0 }}
      animate={{ y: 0, opacity: 1 }}
      className="bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 rounded-xl p-4 hover:bg-gray-800/70 transition-all duration-300"
    >
      <div className="flex items-center justify-between mb-2">
        <h3 className="text-gray-300 text-sm font-medium">{title}</h3>
        {trend && (
          <span className="text-lg">{getTrendIcon(trend)}</span>
        )}
      </div>
      
      <div className="flex items-center justify-between mb-3">
        <div className="text-2xl font-bold text-white">
          {value.toFixed(2)}
        </div>
        <SignalBadge signal={signal} strength={strength} size="sm" />
      </div>
      
      {subtitle && (
        <p className="text-gray-400 text-xs mb-2">{subtitle}</p>
      )}
      
      {children}
    </motion.div>
  );
};

const RSIIndicator: React.FC<{ rsi: RSIData }> = ({ rsi }) => {
  const getRSIColor = (value: number) => {
    if (value > 70) return 'text-red-400';
    if (value < 30) return 'text-green-400';
    return 'text-yellow-400';
  };

  const getRSIZone = (value: number) => {
    if (value > 70) return 'Overbought';
    if (value < 30) return 'Oversold';
    return 'Neutral';
  };

  return (
    <IndicatorCard
      title="RSI (14)"
      value={rsi.value}
      signal={rsi.signal}
      strength={rsi.strength}
      subtitle={getRSIZone(rsi.value)}
    >
      <div className="w-full bg-gray-700 rounded-full h-2 mb-2">
        <motion.div
          initial={{ width: 0 }}
          animate={{ width: `${rsi.value}%` }}
          transition={{ duration: 1, ease: "easeOut" }}
          className={`h-2 rounded-full ${getRSIColor(rsi.value).replace('text-', 'bg-')}`}
        />
      </div>
      <div className="flex justify-between text-xs text-gray-400">
        <span>Oversold (30)</span>
        <span>Overbought (70)</span>
      </div>
    </IndicatorCard>
  );
};

const MACDIndicator: React.FC<{ macd: MACDData }> = ({ macd }) => {
  const getHistogramColor = (value: number) => {
    return value > 0 ? 'bg-green-500' : 'bg-red-500';
  };

  return (
    <IndicatorCard
      title="MACD"
      value={macd.macdLine}
      signal={macd.signal}
      strength={macd.strength}
      subtitle={`Signal: ${macd.signalLine.toFixed(4)}`}
    >
      <div className="space-y-2">
        <div className="flex justify-between text-xs text-gray-400">
          <span>MACD Line: {macd.macdLine.toFixed(4)}</span>
          <span>Signal Line: {macd.signalLine.toFixed(4)}</span>
        </div>
        <div className="flex items-center">
          <span className="text-xs text-gray-400 mr-2">Histogram:</span>
          <div className="flex-1 bg-gray-700 rounded h-1">
            <motion.div
              initial={{ width: 0 }}
              animate={{ width: `${Math.abs(macd.histogram) * 1000}%` }}
              className={`h-1 rounded ${getHistogramColor(macd.histogram)}`}
            />
          </div>
          <span className="text-xs text-gray-300 ml-2">
            {macd.histogram.toFixed(4)}
          </span>
        </div>
      </div>
    </IndicatorCard>
  );
};

const MovingAverageIndicator: React.FC<{ ma: MovingAverageData }> = ({ ma }) => {
  return (
    <IndicatorCard
      title={`${ma.type.toUpperCase()}${ma.period}`}
      value={ma.value}
      signal={ma.signal}
      strength={ma.strength}
      trend={ma.trend}
      subtitle={`${ma.period}-period ${ma.type.toUpperCase()}`}
    />
  );
};

const BollingerBandsIndicator: React.FC<{ bb: BollingerBandsData; currentPrice: number }> = ({ bb, currentPrice }) => {
  const getPositionColor = (position: string) => {
    switch (position) {
      case 'above': return 'text-red-400';
      case 'below': return 'text-green-400';
      default: return 'text-yellow-400';
    }
  };

  const bandWidth = bb.upper - bb.lower;
  const pricePosition = ((currentPrice - bb.lower) / bandWidth) * 100;

  return (
    <IndicatorCard
      title="Bollinger Bands"
      value={bb.middle}
      signal={bb.signal}
      subtitle={`Price ${bb.position} bands ${bb.squeeze ? '(Squeeze)' : ''}`}
    >
      <div className="space-y-2">
        <div className="text-xs text-gray-400 space-y-1">
          <div>Upper: {bb.upper.toFixed(4)}</div>
          <div>Middle: {bb.middle.toFixed(4)}</div>
          <div>Lower: {bb.lower.toFixed(4)}</div>
        </div>
        <div className="relative w-full bg-gray-700 rounded-full h-3">
          <div className="absolute top-0 w-full h-3 bg-gradient-to-r from-green-500/30 via-yellow-500/30 to-red-500/30 rounded-full" />
          <motion.div
            initial={{ left: '50%' }}
            animate={{ left: `${Math.max(0, Math.min(100, pricePosition))}%` }}
            className="absolute top-0.5 w-2 h-2 bg-white rounded-full transform -translate-x-1"
          />
        </div>
      </div>
    </IndicatorCard>
  );
};

const VolumeIndicator: React.FC<{ volume: VolumeAnalysisData }> = ({ volume }) => {
  const getVolumeColor = (ratio: number) => {
    if (ratio > 1.5) return 'text-green-400';
    if (ratio < 0.5) return 'text-red-400';
    return 'text-yellow-400';
  };

  return (
    <IndicatorCard
      title="Volume Analysis"
      value={volume.volume}
      signal={volume.signal}
      subtitle={`${volume.trend} trend`}
    >
      <div className="space-y-2">
        <div className="flex justify-between text-xs text-gray-400">
          <span>Current: {volume.volume.toFixed(0)}</span>
          <span>MA: {volume.volumeMA.toFixed(0)}</span>
        </div>
        <div className="flex items-center">
          <span className="text-xs text-gray-400 mr-2">Ratio:</span>
          <div className="flex-1 bg-gray-700 rounded h-1">
            <motion.div
              initial={{ width: 0 }}
              animate={{ width: `${Math.min(100, volume.volumeRatio * 50)}%` }}
              className={`h-1 rounded ${getVolumeColor(volume.volumeRatio).replace('text-', 'bg-')}`}
            />
          </div>
          <span className={`text-xs ml-2 ${getVolumeColor(volume.volumeRatio)}`}>
            {volume.volumeRatio.toFixed(2)}x
          </span>
        </div>
      </div>
    </IndicatorCard>
  );
};

const TradingRecommendation: React.FC<{ analysis: TechnicalAnalysisResult }> = ({ analysis }) => {
  const recommendation = useMemo(() => getTradingRecommendation(analysis), [analysis]);

  return (
    <motion.div
      initial={{ scale: 0.9, opacity: 0 }}
      animate={{ scale: 1, opacity: 1 }}
      className="bg-gradient-to-r from-gray-800/80 to-gray-900/80 backdrop-blur-sm border border-gray-600/50 rounded-2xl p-6 mb-6"
    >
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-bold text-white">Trading Signal</h2>
        <SignalBadge signal={analysis.overallSignal} strength={analysis.confidence} size="lg" />
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <h3 className="text-sm font-medium text-gray-300 mb-2">Confidence</h3>
          <div className="w-full bg-gray-700 rounded-full h-3">
            <motion.div
              initial={{ width: 0 }}
              animate={{ width: `${analysis.confidence * 100}%` }}
              transition={{ duration: 1, ease: "easeOut" }}
              className="h-3 rounded-full bg-gradient-to-r from-blue-500 to-purple-500"
            />
          </div>
          <span className="text-xs text-gray-400 mt-1 block">
            {(analysis.confidence * 100).toFixed(1)}%
          </span>
        </div>
        
        <div>
          <h3 className="text-sm font-medium text-gray-300 mb-2">Recommendation</h3>
          <div className="text-lg font-bold text-white">
            {recommendation.action.replace('_', ' ').toUpperCase()}
          </div>
          <span className="text-xs text-gray-400">
            Confidence: {(recommendation.confidence * 100).toFixed(1)}%
          </span>
        </div>
      </div>
      
      <div>
        <h3 className="text-sm font-medium text-gray-300 mb-2">Analysis Summary</h3>
        <ul className="space-y-1">
          {recommendation.reasoning.map((reason: string, index: number) => (
            <motion.li
              key={index}
              initial={{ x: -20, opacity: 0 }}
              animate={{ x: 0, opacity: 1 }}
              transition={{ delay: index * 0.1 }}
              className="text-xs text-gray-400 flex items-start"
            >
              <span className="text-blue-400 mr-2">‚Ä¢</span>
              {reason}
            </motion.li>
          ))}
        </ul>
      </div>
    </motion.div>
  );
};

export const TechnicalAnalysisPanel: React.FC<TechnicalAnalysisPanelProps> = ({
  candleData,
  isVisible,
  onToggle
}) => {
  const [analysis, setAnalysis] = useState<TechnicalAnalysisResult | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  useEffect(() => {
    if (isVisible && candleData.length >= 50) {
      setIsLoading(true);
      console.log('üî¨ Running technical analysis on', candleData.length, 'candles');
      console.log('üìä Sample candle data:', candleData[candleData.length - 1]);
      try {
        const result = performTechnicalAnalysis(candleData);
        console.log('‚úÖ Technical analysis result:', result);
        setAnalysis(result);
      } catch (error) {
        console.error('Technical analysis error:', error);
      } finally {
        setIsLoading(false);
      }
    }
  }, [candleData, isVisible]);

  const currentPrice = candleData[candleData.length - 1]?.close || 0;

  return (
    <div className="relative">
      {/* Toggle Button */}
      <motion.button
        onClick={onToggle}
        className="fixed top-4 right-4 z-50 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-lg transition-all duration-300"
        whileHover={{ scale: 1.05 }}
        whileTap={{ scale: 0.95 }}
      >
        üìä Technical Analysis
      </motion.button>

      {/* Analysis Panel */}
      <AnimatePresence>
        {isVisible && (
          <motion.div
            initial={{ x: '100%' }}
            animate={{ x: 0 }}
            exit={{ x: '100%' }}
            transition={{ type: 'spring', damping: 20, stiffness: 300 }}
            className="fixed top-0 right-0 h-full w-96 bg-gray-900/95 backdrop-blur-lg border-l border-gray-700/50 shadow-2xl z-40 overflow-y-auto"
          >
            <div className="p-6">
              <div className="flex items-center justify-between mb-6">
                <h1 className="text-2xl font-bold text-white">Technical Analysis</h1>
                <motion.button
                  onClick={onToggle}
                  className="text-gray-400 hover:text-white transition-colors"
                  whileHover={{ scale: 1.1 }}
                  whileTap={{ scale: 0.9 }}
                >
                  ‚úï
                </motion.button>
              </div>

              {isLoading ? (
                <div className="flex items-center justify-center h-64">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                </div>
              ) : analysis ? (
                <div className="space-y-4">
                  <TradingRecommendation analysis={analysis} />
                  
                  <div className="grid grid-cols-1 gap-4">
                    <RSIIndicator rsi={analysis.rsi} />
                    <MACDIndicator macd={analysis.macd} />
                    <MovingAverageIndicator ma={analysis.sma20} />
                    <MovingAverageIndicator ma={analysis.sma50} />
                    <MovingAverageIndicator ma={analysis.ema12} />
                    <MovingAverageIndicator ma={analysis.ema26} />
                    <BollingerBandsIndicator bb={analysis.bollingerBands} currentPrice={currentPrice} />
                    <VolumeIndicator volume={analysis.volumeAnalysis} />
                  </div>
                </div>
              ) : candleData.length < 50 ? (
                <div className="flex items-center justify-center h-64 text-gray-400 text-center">
                  <div>
                    <div className="text-4xl mb-4">üìà</div>
                    <p>Need at least 50 candles for technical analysis</p>
                    <p className="text-sm mt-2">Current: {candleData.length} candles</p>
                  </div>
                </div>
              ) : (
                <div className="flex items-center justify-center h-64 text-gray-400">
                  <p>No analysis data available</p>
                </div>
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
};
